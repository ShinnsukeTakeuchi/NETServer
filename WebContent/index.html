<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Tomcat WebSocket Test</title>
        <script type="text/javascript">
        	var domain = location.hostname;
        	//alert(domain);
        	var userName = prompt("あなたのお名前は？");

        	try{
	        	var request = new XMLHttpRequest();
	        	var servletUrl = "http://"+domain+":8080/WebSocketServer/SearchRoom?userName="+userName;
	        	var send = "send";
	        	request.open("GET", servletUrl, false);
	       		request.send(send);

	       		var roomId = request.response;
	       		//alert(roomId);
        	}
        	catch(err){
        		alert("失敗しました");
        	}

        	var ws = new WebSocket("ws://"+domain+":8080/WebSocketServer/Post/"+roomId);
        	//alert("ws://"+domain+":8080/WebSocketServer/Post/"+roomId);
        	//function openWebsocket() {
	            ws.onopen = function(){
	            };
        	//}
        	ws.onmessage = function(message){
        		var jsonStr = message.data;
        		var jsonObj = JSON.parse(jsonStr);
                document.getElementById("chatlog").textContent += message.data + "\n";
            };
            function postToServer(){
            	if(window.JSON) {
            		var date = new Date();
            		var strDate = toLocaleString(date);

            		var jsonObj = {
    						"userId":"testUser",
    						"userName":userName,
    						"messeage":document.getElementById("msg").value,
    						"date":strDate
            		};
					var mesStr = '{"userId":"testUser","userName":userName,"messeage":document.getElementById("msg").value,"date":strDate}';
            		//var mesStr = json.stringify(jsonObj):
            		ws.send(mesStr);
                    //ws.send(document.getElementById("msg").value);
                    document.getElementById("msg").value = "";
            	}
            }
            function closeConnect(){
                ws.close();
            }
            function toLocaleString( date )
            {
                return [
                    date.getFullYear(),
                    date.getMonth() + 1,
                    date.getDate()
                    ].join( '.' ) + ' '
                    + date.toLocaleTimeString();
            }
        </script>
    </head>
    <body>
        <textarea id="chatlog" cols="40" rows="10" readonly></textarea><br/>
        <input id="msg" type="text" />
        <button type="submit" id="sendButton" onClick="postToServer()">Send!</button>
        <button type="submit" id="sendButton" onClick="closeConnect()">End</button>

        <form action="SearchRoom" method="GET">
        	<input type="submit" value="送信" />
        	<input type="hidden" value="inRoom" name="value" />
        </form>
    </body>
</html>